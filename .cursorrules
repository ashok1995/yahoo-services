# Yahoo-Services Master Rules

Port: **8014** | Service: Data Kite cannot provide (US indices, commodities, forex, fundamentals)

## ðŸš¨ Critical Rules

**Agent Behavior**
- Agent **runs all commands** (servers, tests, curl, installs). Never ask user to run commands.
- Agent **verifies before integrating** â€” curl external services before wiring them in.
- Test, fix, and commit. User provides instructions only.

**Git Workflow (Strict)** â€” see BRANCH-WORKFLOW.md
- âŒ Never work/commit on `main` or `develop` directly
- âŒ Never merge via command line: use **Pull Requests in GitHub UI** to update develop and main
- âŒ Never push directly to `main`; never run deploy-vm-prod from a feature branch
- âœ… Always create feature branches from `develop` (e.g. feature/xxx, bugfix/xxx), push branch, open PR
- âœ… Flow: feature/xxx â†’ PR â†’ develop (merge in UI) â†’ staging â†’ PR â†’ main (merge in UI) â†’ pull main, deploy VM
- **main** = production VM only. **develop** = staging. All merges via GitHub UI.

## Scope & Endpoints

**Zero Redundancy**: Only data Kite cannot provide
- âœ… US indices (S&P, NASDAQ, VIX), commodities (Gold, Crude), forex (USD/INR), fundamentals
- âŒ NSE/BSE quotes/candles (use Kite)

**Exactly 4 Endpoints** (no new endpoints without approval):
1. `GET /api/v1/global-context` â€” Primary (90% usage)
2. `POST /api/v1/fundamentals/batch` â€” Weekly enrichment
3. `GET /api/v1/alpha-vantage/global-context` â€” Fallback (optional)
4. `GET /health` â€” Health check

## Code Quality (Non-Negotiable)

**Size Limits**
- **Max 300 lines per file** â€” split if larger
- **Max 30 lines per function** â€” extract to smaller units
- **No duplicate logic** â€” DRY strictly enforced

**Standards**
- **Pydantic models mandatory** â€” all endpoints must have request/response models
- **Type hints mandatory** â€” all functions
- **Test before commit** â€” run tests, fix breaks before pushing
- **Scan before writing** â€” look for similar logic, refactor instead of rewrite
- **No hardcoded values** â€” use config for everything
- **Dependency injection** â€” no inline instantiation

**Logging**
- JSON logs to `logs/yahoo-services.log` (rotation: 10MB, keep 5)
- Format: `{timestamp, level, service, module, message, context}`
- NO `print()` statements

**Configuration**
- All config in `config/settings.py` (pydantic-settings)
- Env file: `envs/env.dev` (not root `.env`)
- Validate all config on startup

## File Structure

```
yahoo-services/
â”œâ”€â”€ main.py
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ routes/          # Thin controllers (call services only)
â”‚   â””â”€â”€ models/          # Pydantic request/response models
â”œâ”€â”€ services/            # Business logic (stateless, reusable)
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py      # Centralized config (pydantic-settings)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ logger.py
â”‚   â””â”€â”€ exceptions.py
â”œâ”€â”€ envs/
â”‚   â””â”€â”€ env.dev          # Environment variables (NOT root .env)
â”œâ”€â”€ tests/               # Unit + integration tests
â”œâ”€â”€ logs/                # Log files (gitignored)
â””â”€â”€ docs/                # See documentation rules below
```

## External API Integration

**Before Integration**: Verify external service is reachable
```bash
# Agent runs this before wiring Yahoo/Alpha Vantage
curl -s https://query1.finance.yahoo.com/v8/finance/chart/^GSPC
```

**Document in `docs/api/apis-used.md`**:
- API name, base URL, endpoints used
- Pydantic request/response models
- Purpose, auth, rate limits
- Test coverage for success/failure/edge cases

**No raw HTTP calls** â€” use client wrapper with DI

## Caching & Rate Limiting

- Global context: 5 min | Fundamentals: 1 day
- Yahoo: 100 req/min | Alpha Vantage: 5 req/min
- Error fallback: cached data â†’ Alpha Vantage â†’ 503

## Documentation Rules

**Current State Only** â€” document project as it is NOW
- Remove process docs: "current status", "refactoring plan", "recommendations"
- Remove historical/legacy documentation
- Keep only what reader needs to use/work on project today

**Keep Docs in Sync**
- When code changes, update corresponding docs (architecture, API, services)
- When adding patterns/conventions, update this master rule

**Structure** (no `.md` files at root of `/docs/`)
```
docs/
â”œâ”€â”€ README.md              # Navigation index only
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ api-reference.md
â”‚   â””â”€â”€ apis-used.md       # Document all external APIs
â”œâ”€â”€ architecture/
â”œâ”€â”€ integration/           # Primary for API consumers
â”œâ”€â”€ deployment/
â””â”€â”€ development/
```

**Per Module/Folder**: `README.md` with purpose, entry points, dependencies, examples

## Port Management

Kill by port (8014), not by partial command:
```bash
lsof -ti:8014 | xargs kill -9  # Correct
uvicorn main:app --host 0.0.0.0 --port 8014 --reload
```

## Strictly Forbidden

âŒ Working/committing on `main` or `develop` directly
âŒ Deploying to production from any branch other than `main`
âŒ Files >300 lines, functions >30 lines
âŒ Endpoints without Pydantic models
âŒ API calls without models and `docs/api/apis-used.md` entry
âŒ Committing without running tests first
âŒ Duplicate logic or redundant code
âŒ Hardcoded values, print statements, dead code
âŒ New endpoints without approval
âŒ `.md` files outside repo root or `docs/` subfolders
âŒ Env files outside `/envs/` or named other than `env.dev`
âŒ Non-relevant/orphan files
âŒ Redundant Kite data fetching (use Kite for NSE/BSE)

## Integration Response Format (DO NOT CHANGE)

Called by seed-stocks-service every 5 min. Format MUST match:
```json
{
  "sp500": {"price": 5845.20, "change_percent": 0.45},
  "nasdaq": {"price": 18234.50, "change_percent": 0.62},
  "dow_jones": {"price": 44320.10, "change_percent": 0.28},
  "vix": {"value": 13.45},
  "gold": {"price": 2024.30, "change_percent": -0.15},
  "usd_inr": {"rate": 83.25, "change_percent": 0.08},
  "crude_oil": {"price": 78.45, "change_percent": 1.20},
  "timestamp": "2026-02-12T14:30:00+05:30"
}
```

---

âœ… **Focus**: 4 endpoints, max efficiency, production-grade only
âŒ **Avoid**: Demos, redundancy, >300 LOC files, working on main

See `.cursor/RULE.md` for detailed implementation guidance.
